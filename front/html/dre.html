<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demonstração do Resultado do Exercício (DRE)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos para a tela de DRE - Branco com detalhes azuis */
        :root {
            --cor-principal: #ffffff;
            --cor-detalhe: #4e637a;
            --cor-detalhe-claro: #bbdefb;
            --cor-texto: #333333;
            --cor-negativo: #e53935;
            --cor-positivo: #06a80e;
            --cor-borda: #000000;
            --sombra-suave: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dre-container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--cor-principal);
            border-radius: 8px;
            box-shadow: var(--sombra-suave);
            padding: 30px;
            border-top: 4px solid var(--cor-detalhe);
        }

        .dre-container h1 {
            color: var(--cor-detalhe);
            text-align: center;
            margin-bottom: 30px;
            font-weight: 600;
            font-size: 28px;
            border-bottom: 2px solid var(--cor-detalhe-claro);
            padding-bottom: 15px;
        }

        .dre-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .dre-table th {
            background-color: var(--cor-detalhe);
            color: white;
            text-align: left;
            padding: 12px 15px;
            font-weight: 600;
        }

        .dre-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--cor-borda);
        }

        .dre-table .valor {
            text-align: right;
            font-family: 'Consolas', monospace;
            font-weight: 500;
        }

        .dre-table .deducao {
            color: var(--cor-negativo);
        }

        .dre-table .resultado {
            background-color: var(--cor-detalhe-claro);
            font-weight: 600;
        }

        .dre-table .resultado-intermediario {
            background-color: #e3f2fd;
            font-weight: 600;
        }

        .dre-table .final {
            background-color: var(--cor-detalhe);
            color: white;
            font-weight: 700;
            font-size: 1.1em;
        }

        .dre-table .final .valor {
            color: white;
        }

        .dre-table .subitem {
            padding-left: 30px;
            font-style: italic;
            color: #555;
        }

        /* Responsividade para telas menores */
        @media (max-width: 768px) {
            .dre-container {
                padding: 15px;
            }
            
            .dre-table th, 
            .dre-table td {
                padding: 8px 10px;
                font-size: 14px;
            }
            
            .dre-container h1 {
                font-size: 22px;
            }
        }

        /* Efeitos de hover para melhorar a experiência do usuário */
        .dre-table tbody tr:hover {
            background-color: rgba(187, 222, 251, 0.3);
            transition: background-color 0.2s ease;
        }

        /* Estilização para valores positivos */
        .dre-table .valor:not(.deducao) {
            color: var(--cor-positivo);
        }

        /* Estilos da barra lateral */
        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 6px;
            color: #4b5563;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .menu-item:hover {
            background-color: #f3f4f6;
            color: #111827;
        }

        .menu-item.active {
            background-color: #e5e7eb;
            color: #111827;
            font-weight: 500;
        }

        .menu-item i {
            width: 24px;
            text-align: center;
        }

        /* Layout principal */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* Barra lateral responsiva */
        @media (max-width: 768px) {
            #sideMenu {
                transform: translateX(-100%);
            }
            
            #sideMenu.open {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 font-sans transition-colors duration-300 min-h-screen flex">

    <!-- Menu Lateral -->
    <div id="sideMenu" class="flex flex-col w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 transition-all duration-300 ease-in-out fixed md:relative h-screen z-40">
        <div class="p-4 flex items-center justify-between">
            <div class="text-xl font-bold text-gray-800 dark:text-white">Jogo de Negócios</div>
            <button id="toggleSidebar" class="text-gray-500 dark:text-gray-400 md:hidden">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
        <nav class="flex-1 overflow-y-auto p-2 space-y-1">
            <a href="./dashboard.html" class="menu-item">
                <i class="fas fa-home mr-3"></i>
                <span>Dashboard</span>
            </a>
            <a href="./gameCreation-aluno.html" class="menu-item">
                <i class="fas fa-box-open mr-3"></i>
                <span>Dados da Empresa</span>
            </a>
            <a href="./financial.html" class="menu-item active">
                <i class="fas fa-chart-bar mr-3"></i>
                <span>Financeiro</span>
            </a>
            <a href="./marketing.html" class="menu-item">
                <i class="fas fa-box-open mr-3"></i>
                <span>Marketing</span>
            </a>
            <a href="./humanResources.html" class="menu-item">
                <i class="fas fa-users mr-3"></i>
                <span>Recursos Humanos</span>
            </a>
            <a href="./production.html" class="menu-item">
                <i class="fas fa-industry mr-3"></i>
                <span>Produção</span>
            </a>
            <a href="./strategicDecisions.html" class="menu-item">
                <i class="fas fa-brain mr-3"></i>
                <span>Tomar Decisões</span>
            </a>
            <a href="./roundResults.html" class="menu-item">
                <i class="fas fa-award mr-3"></i>
                <span>Resultados da Rodada</span>
            </a>
        </nav>
        <div class="border-t border-gray-200 dark:border-gray-700 p-2 space-y-1">
            <a href="./notifications.html" class="menu-item">
                <i class="fas fa-bell mr-3"></i>
                <span>Notificações</span>
            </a>
            <button id="settingsButton" class="menu-item w-full text-left">
                <i class="fas fa-cog mr-3"></i>
                <span>Configurações</span>
            </button>
            <button id="logoutButton" class="menu-item w-full text-left">
                <i class="fas fa-sign-out-alt mr-3"></i>
                <span>Sair</span>
            </button>
        </div>
    </div>

    <!-- Conteúdo Principal -->
    <div class="main-content">
        <div class="dre-container">
            <h1>Demonstração do Resultado do Exercício (DRE)</h1>
            
            <table class="dre-table">
                <thead>
                    <tr>
                        <th>Descrição</th>
                        <th>Valor (R$)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>(+) Receita Bruta de Vendas</td>
                        <td class="valor" id="receita-bruta">0,00</td>
                    </tr>
                    <tr>
                        <td>(-) Deduções da Receita Bruta (ICMS)</td>
                        <td class="valor deducao" id="deducao-icms">0,00</td>
                    </tr>
                    <tr class="resultado">
                        <td>(=) Receita Líquida de Vendas</td>
                        <td class="valor" id="receita-liquida">0,00</td>
                    </tr>
                    <tr>
                        <td>(-) Custo da Mercadoria Vendida (CMV)</td>
                        <td class="valor deducao" id="cmv">0,00</td>
                    </tr>
                    <tr class="resultado">
                        <td>(=) Lucro Bruto</td>
                        <td class="valor" id="lucro-bruto">0,00</td>
                    </tr>
                    <tr>
                        <td>(-) Despesas Operacionais</td>
                        <td class="valor deducao"></td>
                    </tr>
                    <tr>
                        <td class="subitem">Despesas Comerciais (Salários)</td>
                        <td class="valor deducao" id="despesa-comercial">0,00</td>
                    </tr>
                    <tr>
                        <td class="subitem">Despesas Administrativas</td>
                        <td class="valor deducao" id="despesa-administrativa">0,00</td>
                    </tr>
                    <tr class="resultado-intermediario">
                        <td>(=) Lucro Operacional (Antes do IRPJ)</td>
                        <td class="valor" id="lucro-antes-imposto">0,00</td>
                    </tr>
                    <tr>
                        <td>(-) Imposto de Renda Pessoa Jurídica (IRPJ)</td>
                        <td class="valor deducao" id="irpj">0,00</td>
                    </tr>
                    <tr class="resultado final">
                        <td>(=) Lucro Líquido do Exercício</td>
                        <td class="valor" id="lucro-liquido">0,00</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Botão para abrir o menu em mobile -->
    <button id="mobileMenuButton" class="md:hidden fixed bottom-4 right-4 bg-blue-600 text-white p-3 rounded-full shadow-lg z-50">
        <i class="fas fa-bars"></i>
    </button>

    <script>
        // Função otimizada para buscar o maior ID de empresa em gestão
async function buscarMaiorIdEmpresa() {
    try {
        // Tenta primeiro buscar a lista completa
        const response = await fetch('http://localhost:8080/empresa-em-gestao');
        
        if (response.status === 404) {
            // Se o endpoint não existir, tenta o método iterativo
            console.log('Endpoint /empresa-em-gestao não encontrado, tentando busca iterativa...');
            return await buscarMaiorIdIterativo();
        }
        
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const empresas = await response.json();
        
        if (!empresas || empresas.length === 0) {
            return await buscarMaiorIdIterativo();
        }
        
        // Encontra o maior ID na lista
        const maiorId = Math.max(...empresas.map(emp => emp.id));
        console.log('Maior ID encontrado na lista:', maiorId);
        return maiorId;
        
    } catch (error) {
        console.error('Erro na busca por lista, tentando método iterativo:', error);
        return await buscarMaiorIdIterativo();
    }
}

// Método iterativo para buscar o maior ID (fallback)
async function buscarMaiorIdIterativo() {
    console.log('Iniciando busca iterativa por ID...');
    const MAX_ID = 100; // Ajuste conforme necessário
    
    for (let id = MAX_ID; id >= 1; id--) {
        try {
            const response = await fetch(`http://localhost:8080/empresa-em-gestao/${id}`);
            if (response.ok) {
                console.log(`ID válido encontrado: ${id}`);
                return id;
            }
        } catch (error) {
            console.warn(`Erro ao verificar ID ${id}:`, error.message);
        }
        
        // Delay para não sobrecarregar o servidor
        await new Promise(resolve => setTimeout(resolve, 50));
    }
    
    throw new Error('Nenhuma empresa encontrada (método iterativo)');
}

// Função principal para carregar o DRE
async function carregarDadosDRE() {
    try {
        const empresaId = await buscarMaiorIdEmpresa();
        console.log(`Buscando DRE para empresa ID: ${empresaId}`);
        
        const response = await fetch(`http://localhost:8080/empresa-em-gestao/${empresaId}`);
        if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
        
        const empresa = await response.json();
        
        if (!empresa.dreMaisRecente) {
            throw new Error('DRE não disponível para esta empresa');
        }
        
        preencherDRE(empresa.dreMaisRecente);
        
    } catch (error) {
        console.error('Erro ao carregar DRE:', error);
        mostrarErro(`Falha ao carregar dados financeiros: ${error.message}`);
    }
}

// Função para preencher a tabela DRE
function preencherDRE(dre) {
    const campos = {
        'receita-bruta': dre.receitaBruta,
        'deducao-icms': dre.deducaoIcms,
        'receita-liquida': dre.receitaLiquida,
        'cmv': dre.custoMercadoriaVendida,
        'lucro-bruto': dre.lucroBruto,
        'despesa-comercial': dre.despesaComercial,
        'despesa-administrativa': dre.despesaAdministrativa,
        'lucro-antes-imposto': dre.lucroAntesImposto,
        'irpj': dre.impostoRendaPessoaJuridica,
        'lucro-liquido': dre.lucroLiquido
    };

    Object.entries(campos).forEach(([id, valor]) => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.textContent = formatarMoeda(valor);
        }
    });
}

// Função para mostrar erros na interface
function mostrarErro(mensagem) {
    // Remove erros anteriores
    document.querySelectorAll('.erro-dre').forEach(el => el.remove());
    
    const erroDiv = document.createElement('div');
    erroDiv.className = 'erro-dre bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4';
    erroDiv.innerHTML = `
        <strong>Erro:</strong> ${mensagem}
        <button onclick="carregarDadosDRE()" class="ml-2 text-blue-600">Tentar novamente</button>
    `;
    
    const container = document.querySelector('.dre-container');
    if (container) {
        container.prepend(erroDiv);
    }
}

// Função para formatar valores monetários
function formatarMoeda(valor) {
    return valor?.toLocaleString('pt-BR', {
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }) || '0,00';
}

// Inicia quando a página carrega
document.addEventListener('DOMContentLoaded', carregarDadosDRE);
    </script>
</body>
</html>