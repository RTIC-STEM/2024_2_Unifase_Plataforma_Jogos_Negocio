<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo de Negócios - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../css/dashboard.css">
</head>
<body class="bg-gray-50 dark:bg-gray-900 font-sans transition-colors duration-300 h-screen overflow-hidden">

    <div class="flex h-screen">
        <!-- Menu Lateral -->
        <div id="sideMenu" class="flex flex-col h-screen w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 transition-all duration-300 ease-in-out transform -translate-x-full md:translate-x-0 fixed md:relative z-40">
            <div class="p-4 flex items-center justify-between">
                <div class="text-xl font-bold text-gray-800 dark:text-white">Jogo de Negócios</div>
                <button id="toggleSidebar" class="text-gray-500 dark:text-gray-400">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
            <nav class="flex-1 overflow-y-auto p-2 space-y-1">
                <a href="./dashboard.html" class="menu-item active">
                    <i class="fas fa-home mr-3"></i>
                    <span>Dashboard</span>
                </a>
                 <a href="./gameCreation-aluno.html" class="menu-item">
                    <i class="fas fa-box-open mr-3"></i>
                    <span>Dados da Empresa</span>
                </a>
                <a href="./dre.html" class="menu-item">
                    <i class="fas fa-chart-bar mr-3"></i>
                    <span>DRE</span>
                </a>
                <a href="./financial.html" class="menu-item">
                    <i class="fas fa-chart-bar mr-3"></i>
                    <span>Financeiro</span>
                </a>
                <a href="./marketing.html" class="menu-item">
                    <i class="fas fa-box-open mr-3"></i>
                    <span>Marketing</span>
                </a>
                <a href="./humanResources.html" class="menu-item">
                    <i class="fas fa-users mr-3"></i>
                    <span>Recursos Humanos</span>
                </a>
                <a href="./production.html" class="menu-item">
                    <i class="fas fa-industry mr-3"></i>
                    <span>Produção</span>
                </a>
                <a href="./strategicDecisions.html" class="menu-item">
                    <i class="fas fa-brain mr-3"></i>
                    <span>Tomar Decisões</span>
                </a>
                <a href="./roundResults.html" class="menu-item">
                    <i class="fas fa-award mr-3"></i>
                    <span>Resultados da Rodada</span>
                </a>
            </nav>
            <div class="border-t border-gray-200 dark:border-gray-700 p-2 space-y-1">
                <a href="./notifications.html" class="menu-item">
                    <i class="fas fa-bell mr-3"></i>
                    <span>Notificações</span>
                </a>
                <button id="settingsButton" class="menu-item w-full text-left">
                    <i class="fas fa-cog mr-3"></i>
                    <span>Configurações</span>
                </button>
                <button id="logoutButton" class="menu-item w-full text-left">
                    <i class="fas fa-sign-out-alt mr-3"></i>
                    <span>Sair</span>
                </button>
            </div>
        </div>

        <!-- Conteúdo Principal -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- DashboardHeader -->
            <header class="sticky top-0 z-30 flex h-16 items-center gap-4 border-b bg-white dark:bg-gray-800 px-6 dark:border-gray-700">
                <div class="flex flex-1 items-center justify-between">
                    <div>
                    <h1 class="text-lg font-semibold dark:text-white" id="nomeEmpresa">Carregando...</h1>
                    <p class="text-xs text-gray-500 dark:text-gray-400 capitalize" id="currentDate"></p>
                    </div>

                    <div class="flex items-center gap-4">
                        <button class="relative text-blue-500 hover:text-blue-400" title="Portal de Notícias">
                            <i class="fas fa-newspaper text-xl"></i>
                            <span class="absolute top-0 right-0 h-2.5 w-2.5 rounded-full bg-blue-500 animate-pulse"></span>
                        </button>
                        <button class="relative text-gray-500 dark:text-gray-400" title="Notificações">
                            <i class="fas fa-bell"></i>
                            <span class="absolute top-1 right-1 h-2 w-2 rounded-full bg-blue-500"></span>
                        </button>
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium hidden md:inline-block dark:text-white">CEO</span>
                            <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center overflow-hidden">
                                <img src="https://i.pravatar.cc/100" alt="Avatar" class="w-full h-full object-cover">
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Conteúdo -->
            <main class="flex-1 overflow-auto p-4 md:p-6">
                <div class="grid gap-6 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold tracking-tight dark:text-white">Visão Geral</h2>
                            <p class="text-gray-500 dark:text-gray-400">Trimestre 3, Rodada 2</p>  <!-- mudar-->
                        </div>
                        <div>
                            <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-green-900 dark:text-green-300">Em andamento</span>
                        </div>
                    </div>
                    <div class="border-t border-gray-200 dark:border-gray-700"></div>
                    <!-- Metric Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Lucro Líquido</p>
                        <h3 id="lucro-liquido" class="text-xl font-bold text-gray-800 dark:text-white mt-2 truncate max-w-full break-words">Carregando...</h3>
                        <p class="text-green-600 dark:text-green-400 mt-1 flex items-center">
                           <!--  <i class="fas fa-arrow-up mr-1"></i>-->
                        </p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Receita</p>
                        <h3 id="receita" class="text-xl font-bold text-gray-800 dark:text-white mt-2 truncate max-w-full break-words">Carregando...</h3>
                        <p class="text-green-600 dark:text-green-400 mt-1 flex items-center">
                          <!--   <i class="fas fa-arrow-up mr-1"></i> -->
                        </p>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Unidades Vendidas</p>
                        <h3 id="unidades-vendidas" class="text-xl font-bold text-gray-800 dark:text-white mt-2 truncate max-w-full break-words">Carregando...</h3>
                        <p class="text-red-600 dark:text-red-400 mt-1 flex items-center">
                           <!--  <i class="fas fa-arrow-down mr-1"></i> -->
                        </p>
                        </div>

                      <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Lucro Bruto</p>
                        <h3 id="lucro-bruto" class="text-xl font-bold text-gray-800 dark:text-white mt-2 truncate max-w-full break-words">Carregando...</h3>
                        <p class="text-green-600 dark:text-green-400 mt-1 flex items-center">
                           <!--  <i class="fas fa-arrow-up mr-1"></i> -->
                        </p>
                        </div>
                        </div>
                <!-- Gráficos e seções -->
            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <!-- Desempenho Financeiro -->
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow col-span-2">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2">Desempenho Financeiro</h3>
                    <div class="h-64">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>
                <!-- Distribuição de Custos -->
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2">Distribuição de Custos</h3>
                    <div class="h-64">
                        <canvas id="expensesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
</div>


    <!-- Modal de Configurações -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold dark:text-white">Configurações</h3>
                <button id="closeSettings" class="text-gray-500 dark:text-gray-400">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tema</label>
                    <select class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                        <option value="light">Claro</option>
                        <option value="dark">Escuro</option>
                        <option value="system">Seguir sistema</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Idioma</label>
                    <select class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white">
                        <option value="pt">Português</option>
                        <option value="en">Inglês</option>
                        <option value="es">Espanhol</option>
                    </select>
                </div>
                <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">
                        Salvar Configurações
                    </button>
                </div>
            </div>
        </div>
    </div>
<canvas id="financialChart" width="600" height="400"></canvas>
<canvas id="expensesChart"></canvas>
    <script src="menu-script.js"></script>
</body>
</html>

<script>
// Função para recarregar o Swagger UI
// Modifique a função recarregarSwagger para verificar se está na página do Swagger
function recarregarSwagger() {
    // Verifica se estamos na página do Swagger (swagger-ui/index.html)
    if (window.location.pathname.includes('swagger-ui')) {
        const swaggerFrame = document.querySelector('iframe');
        if (swaggerFrame) {
            swaggerFrame.src = swaggerFrame.src;
            console.log('Swagger UI recarregado');
        } else {
            console.log('Iframe do Swagger não encontrado - Pode não ser a página do Swagger');
        }
    }
}

// No seu código principal, adicione uma verificação antes de chamar recarregarSwagger
async function carregarDados() {
    try {
        atualizarData();
        
        const empresaId = await buscarMaiorIdEmpresa();
        console.log(`Buscando dados da empresa ID: ${empresaId}`);

        const response = await fetch(`http://localhost:8080/empresa-em-gestao/${empresaId}`);
        if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
        
        const data = await response.json();
        
        atualizarDadosDaEmpresa(data);
        processarDadosParaGraficos(data);
        
        // Só tenta recarregar o Swagger se estivermos na página dele
        if (window.location.pathname.includes('swagger-ui')) {
            recarregarSwagger();
        }

    } catch (error) {
        console.error("Erro ao carregar dados:", error);
        mostrarDadosMockados();
        mostrarErrosNaPagina();
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    // Versão otimizada da função para buscar o maior ID
    async function buscarMaiorIdEmpresa() {
        try {
            let tentativas = 0;
            const maxTentativas = 5;
            const delay = 1000;

            while (tentativas < maxTentativas) {
                try {
                    // 1. Tenta buscar a lista completa primeiro
                    const responseLista = await fetch('http://localhost:8080/empresa-em-gestao');
                    if (responseLista.ok) {
                        const empresas = await responseLista.json();
                        if (empresas.length > 0) {
                            const empresaMaiorId = empresas.reduce((max, empresa) => 
                                empresa.id > max.id ? empresa : max
                            );
                            
                            // Verificação extra
                            const verifyResponse = await fetch(`http://localhost:8080/empresa-em-gestao/${empresaMaiorId.id}`);
                            if (verifyResponse.ok) {
                                console.log(`ID confirmado: ${empresaMaiorId.id}`);
                                return empresaMaiorId.id;
                            }
                        }
                    }

                    // 2. Fallback: busca iterativa
                    for (let id = 100; id >= 1; id--) {
                        try {
                            const testResponse = await fetch(`http://localhost:8080/empresa-em-gestao/${id}`);
                            if (testResponse.ok) {
                                console.log(`ID válido encontrado: ${id}`);
                                return id;
                            }
                        } catch (error) {
                            console.warn(`Teste com ID ${id} falhou:`, error);
                        }
                    }

                } catch (error) {
                    console.error(`Tentativa ${tentativas + 1} falhou:`, error);
                }

                tentativas++;
                if (tentativas < maxTentativas) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            throw new Error(`Nenhuma empresa válida encontrada após ${maxTentativas} tentativas`);
            
        } catch (error) {
            console.error("Erro ao buscar maior ID:", error);
            throw error;
        }
    }

    // Exibe a data atual formatada
    function atualizarData() {
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('pt-BR', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    }

    // Função para obter os últimos 6 meses
    function getLastSixMonths() {
        const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        const today = new Date();
        const months = [];
        
        for (let i = 5; i >= 0; i--) {
            const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
            months.push(monthNames[date.getMonth()]);
        }
        
        return months;
    }

    // Função para formatar valores monetários
    function formatMoney(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value || 0);
    }

    // Dados mockados
    const meses = getLastSixMonths();
    const receitaMock = [15000, 18000, 22000, 19000, 21000]; 
    const custoMock = [8000, 9500, 12000, 10500, 11000];
    const lucroMock = [7000, 8500, 10000, 8500, 10000];

    // Função principal para carregar dados
    async function carregarDados() {
        try {
            atualizarData();
            
            const empresaId = await buscarMaiorIdEmpresa();
            console.log(`Buscando dados da empresa ID: ${empresaId}`);

            const response = await fetch(`http://localhost:8080/empresa-em-gestao/${empresaId}`);
            if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
            
            const data = await response.json();
            
            // Atualiza os dados na página
            atualizarDadosDaEmpresa(data);
            
            // Processa os dados para os gráficos
            processarDadosParaGraficos(data);
            
            // Recarrega o Swagger após carregar os dados
            recarregarSwagger();

        } catch (error) {
            console.error("Erro ao carregar dados:", error);
            mostrarDadosMockados();
            mostrarErrosNaPagina();
        }
    }

    function atualizarDadosDaEmpresa(data) {
        const elementos = [
            { id: "lucro-liquido", valor: data.dreMaisRecente?.lucroLiquido, formatar: formatMoney },
            { id: "receita", valor: data.dreMaisRecente?.receitaLiquida, formatar: formatMoney },
            { id: "unidades-vendidas", valor: data.dreMaisRecente?.quantidadeDeVendas, formatar: (v) => v?.toLocaleString('pt-BR') || '0' },
            { id: "lucro-bruto", valor: data.dreMaisRecente?.lucroBruto, formatar: formatMoney },
            { id: "nome-empresa", valor: data.nomeEmpresa, formatar: (v) => v || "Empresa" },
            { id: "nomeEmpresa", valor: data.nomeEmpresa, formatar: (v) => v || "Empresa" }
        ];

        elementos.forEach(item => {
            const elemento = document.getElementById(item.id);
            if (elemento) {
                elemento.textContent = item.formatar(item.valor);
                if (item.id === "nomeEmpresa" || item.id === "nome-empresa") {
                    elemento.dataset.empresaId = data.id || "0";
                }
            }
        });
    }

    function processarDadosParaGraficos(data) {
        // Dados reais + mockados
        const receitaFinal = [...receitaMock, data.dreMaisRecente?.receitaLiquida || 0];
        const custoFinal = [...custoMock, data.dreMaisRecente?.custoMercadoriaVendida || 0];
        const lucroFinal = [...lucroMock, data.dreMaisRecente?.lucroBruto || 0];

        criarGraficoFinanceiro(receitaFinal, custoFinal, lucroFinal);

        // Dados de distribuição de custos
        const salario = Number(data.dreMaisRecente?.salarioFuncionario) || 0;
        const despesaAdm = Number(data.dreMaisRecente?.despesaAdministrativa) || 0;
        const despesaOper = Number(data.dreMaisRecente?.despesaOperacional) || 0;
        const despesaComercial = Number(data.dreMaisRecente?.despesaComercial) || 0;

        criarGraficoDistribuicaoCustos(salario, despesaAdm, despesaOper, despesaComercial);
    }

    function criarGraficoFinanceiro(receita, custo, lucro) {
        const ctx = document.getElementById('financialChart')?.getContext('2d');
        if (!ctx) return;

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: meses,
                datasets: [
                    {
                        label: 'Receita',
                        data: receita,
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2
                    },
                    {
                        label: 'Custos',
                        data: custo,
                        borderColor: '#FF6384',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2
                    },
                    {
                        label: 'Lucro',
                        data: lucro,
                        borderColor: '#4BC0C0',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2
                    }
                ]
            },
            options: getChartOptions('Desempenho Financeiro - Últimos 6 Meses')
        });
    }

    function criarGraficoDistribuicaoCustos(salario, despesaAdm, despesaOper, despesaComercial) {
        const total = salario + despesaAdm + despesaOper + despesaComercial;
        if (total === 0) {
            console.warn("Dados insuficientes para gráfico de distribuição de custos");
            return;
        }

        const ctx2 = document.getElementById('expensesChart')?.getContext('2d');
        if (!ctx2) return;

        new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Salários', 'Administrativa', 'Operacional', 'Comercial'],
                datasets: [{
                    data: [salario, despesaAdm, despesaOper, despesaComercial],
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
                    borderWidth: 1
                }]
            },
            options: getChartOptions('Distribuição de Custos', true)
        });
    }

    function getChartOptions(title, isDoughnut = false) {
        const options = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: title,
                    font: { size: 16 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = `${context.dataset.label}: ${formatMoney(context.raw)}`;
                            if (isDoughnut) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percent = ((context.raw / total) * 100).toFixed(2);
                                label += ` (${percent}%)`;
                            }
                            return label;
                        }
                    }
                }
            }
        };

        if (!isDoughnut) {
            options.scales = {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatMoney(value);
                        }
                    }
                }
            };
        }

        return options;
    }

    function mostrarDadosMockados() {
        const receitaComplete = [...receitaMock, 23000];
        const custoComplete = [...custoMock, 12500];
        const lucroComplete = [...lucroMock, 10500];
        
        criarGraficoFinanceiro(receitaComplete, custoComplete, lucroComplete);
        criarGraficoDistribuicaoCustos(5000, 3000, 2000, 2500);
    }

    function mostrarErrosNaPagina() {
        const elementosErro = [
            "lucro-liquido", "receita", "unidades-vendidas", 
            "lucro-bruto", "nome-empresa", "nomeEmpresa"
        ];
        
        elementosErro.forEach(id => {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.textContent = id.includes("nome") ? "Empresa (não encontrada)" : "Dados não disponíveis";
                elemento.classList.add(id.includes("nome") ? "erro-texto" : "erro-dados");
            }
        });
    }

    // Inicia o carregamento dos dados
    carregarDados();
});


</script>
</body>
</html>